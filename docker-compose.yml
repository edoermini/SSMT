version: '3'
services:

    influxdb:
        image: influxdb
        volumes:
            # Mount for influxdb data directory and configuration
            - influxdbv2:/.influxdbv2
        ports:
            - 8086:8086

    # Use the influx cli to set up an influxdb instance. 
    influxdb_cli:
        links:
            - influxdb
        image: influxdb
        # Use these same configurations parameters in your telegraf configuration, mytelegraf.conf.
        entrypoint: bash -c "influx setup --bucket snmp -t influx -o influx --username=influx --password=influxdb --host=http://influxdb:8086 -f && influx apply --org influx -u https://raw.githubusercontent.com/influxdata/community-templates/master/snmp/snmp.yml"
            # Wait for the influxd service in the influxdb container has fully bootstrapped before trying to setup an influxdb instance with the influxdb_cli service. 
        restart: on-failure:10
        depends_on:
            - influxdb
    
    telegraf:
        image: telegraf
        command: bash -c "
            echo 'deb http://deb.debian.org/debian/ buster main contrib non-free
            deb http://deb.debian.org/debian/ buster-updates main contrib non-free
            deb http://security.debian.org/debian-security buster/updates main contrib non-free' > /etc/apt/sources.list &&
            apt-get update &&
            apt-get install snmp -y &&
            apt-get install snmp-mibs-downloader -y &&
            telegraf"
        links:
            - influxdb
        volumes:
            # Mount for telegraf config
            - ./telegraf.conf:/etc/telegraf/telegraf.conf
        environment: 
            - INFLUX_HOST=http://influxdb:8086
            - INFLUX_TOKEN=influx
            - INFLUX_ORG=influx
            - INFLUX_BUCKET=snmp
            - SNMP_AGENT=udp://172.17.0.1:161
            - SNMP_VERSION=1
            - SNMP_COMMUNITY=ssmt
            - MIBS=ALL
        depends_on:
            - influxdb_cli

volumes:
    influxdbv2: